{% extends "index.html" %}

{% block script  %}
<script src="../js/jquery.min.js"></script>
<script src="../js/highcharts.js"></script>
<script>

$(document).ready(function() 
{
	//get a list of activities and decide if we are going to draw a graph
	//or show a message instead
	$.getJSON('../activities/update_datatable', function(activity_list){
		drawGraphOrShowMessageDependingOnListContent(activity_list['aaData']);
	});	

	$("button").click(function()
	{
		var today = new Date();
		var startDate = today;
		var graphData = new Array();
		var timeType = $("#select3").val();
		var measureType = $("#select2").val();
		var actType = $("#select1").val();

		startDate = dateConversion(today,timeType);
		today = dateConversion(today,"day");

		//ask server for the data and dump it into the graphdata variable
		//if the user wants max_speed, we look for a maximum
		if (measureType == "max_speed")
		{
			$.getJSON("get_maximum",
			{
				column_name: measureType,
				activity_name: actType,
				start_date: startDate,
				end_date: today,
				group_by: "day"
			},
				function(activity_list)
				{
					drawGraph(activity_list);
				});
		}
		//if the user does not want max_speed, we find a total
		else
		{
			$.getJSON("get_total",
			{
				column_name: measureType,
				activity_name: actType,
				start_date: startDate,
				end_date: today,
				group_by: "day"
			},
				function(activity_list)
				{
					drawGraph(activity_list);
				});
		}
	});//button click function	
});//document ready

function drawGraphOrShowMessageDependingOnListContent(activity_list)
{
	if(activity_list.length > 0)
	{
		$('#noActivitiesMessage').hide();
		$("button").click(); //simulate a click on the "update" button to draw graph
	}
	else
	{
		$('#graphContainer').hide();
		$('#searchTerms').hide();
		appendNoActivitiesMessageToDiv();
	}
}

function appendNoActivitiesMessageToDiv()
{
	$("#noActivitiesMessage").append(
		'<div style="padding-left:10%; padding-right:10%; padding-top:2%" align="center">' +
			'<div class="well" style="height:150px">'+
				'<dl>' +
					'<dt>' +
						'<h1>Workout Statistics</h1>' +
						'<br />' +
						'<p>You haven\'t logged any activities yet.<br/><a href="../activities">Click here</a> to log one! :)</p>' +
					'</dt>' +
					'<dd id="about_me" class="edit"></dd>' +
				'</dl>' +
			'</div>' +
		'</div>'
	);
}

//dateConversion function
//-----------------------
//takes the raw date given by new Date() and
//converts it into the format used by our database
// date - raw date to convert
// timeframe - "day","week","month","year"

function dateConversion(date,timeframe) 
{
    var result;

	//find the correct startDate based on selection
	if (timeframe == "day"){
		result = date.getFullYear() + "-" + (date.getMonth()+1) + "-" + date.getDate();
	}

	//TODO:fix this for when a week begins and ends in different months
	else if (timeframe == "week"){
		result = date.getFullYear() + "-" + (date.getMonth()+1) + "-" + (date.getDate()-date.getDay());
	}
	else if (timeframe == "month"){
		result = date.getFullYear() + "-" + (date.getMonth()+1) + "-1";
	}
	else if (timeframe == "year"){
		result = date.getFullYear() + "-1-1";
	}

	return result;
}

//drawGraph function
//------------------
//takes the raw "data" returned from the server to create a line graph
//	myData - the data sent back from the server after calling get_total, etc
//	it is in the format (value,year,month,day,...), this will need to be converted

function drawGraph(myData) 
{
	var strData = [];
	var splitStr = [];
	var myValues = new Array();
	var myDates = [];
	var year;
	var month;
	var day;
	var myValue;

	//must convert data into a string format to manipulate it
	for (var i=0;i<myData.length;i++) {
		strData.push(String(myData[i]));
	}

	for (var i=0;i<strData.length;i++){

		splitStr = strData[i].split(",");

		for (var j=0;j<splitStr.length;j++){

			if (j%4 == 0) {
				myValue = parseInt(splitStr[j]);
			}

			else if (j%4 == 1){
				year = splitStr[j];
			}

			else if (j%4 == 2){
				month = splitStr[j];
			}

			else if (j%4 == 3){
				day = splitStr[j];
				myValues.push([Date.UTC(year, month, day), myValue]);
			}//else
		}//for
	}//for

	myValues.sort();

	//TODO: clean up hard-coded values in this function

	var myChart = new Highcharts.Chart({
        chart: {
            renderTo: "graphContainer",
            type: "spline"
        },
        title: {
            text: $("#select1").val()  + " / " + $("#select3").val()
        },
        xAxis: {
            type: 'datetime'
        },
        yAxis: {
            title: {
                text: $("#select2").val()
            },
            min: 0
        },
        tooltip: {
		    formatter: function() {
		        return '<b>'+ this.series.name +'</b><br/>'+
		        Highcharts.dateFormat('%e. %b', this.x) +': '+ this.y +' m';
		     }
        },

        series: [{
        	showInLegend: false,
            	name: "Item",
            	data: myValues
        }]
    });//draw graph function
}//drawgraph function

</script>

{% endblock script %}
{% block body %}


<div id="noActivitiesMessage"></div>

<div id="graphContainer" style="width:100%; height:400px;"></div>
<br><br>
<div id="searchTerms" align="center">
	Activity:
	<select size="1" id="select1">
		<option value ="Run" selected="selected">Run</option>
		<option value ="Walk">Walk</option>
		<option value ="Bike">Bike</option>
	</select>
	Metric Used:
	<select size="1" id="select2">
		<option value="distance" selected="selected">Distance</option>
		<option value="duration">Duration</option>
		<option value="max_speed">Max Speed</option>
	</select>
	Time Frame:
	<select size="1" id="select3">
		<option value="week" selected="selected">Week</option>
		<option value="month">Month</option>
		<option value="year">Year</option>
	</select>
	<button type="button" class="btn btn-primary">Update</button>
</div>
<br>

{% endblock body %}
