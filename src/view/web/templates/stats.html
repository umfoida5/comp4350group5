{% extends "index.html" %}

{% block script  %}
<script src="../js/jquery.min.js"></script>
<script src="../js/highcharts.js"></script>
<script>

$(document).ready(function() {

	$("button").click(function(){
		var today = new Date();
		var startDate = today;
		var graphData = new Array();
		var timeType = $("#select3").val();
		var measureType = $("#select2").val();
		var statType = $("#select1").val();
		var actType = $("#select0").val();

		startDate = dateConversion(today,timeType);
		today = dateConversion(today,"day");

		//ask server for the data and dump it into the graphdata variable
		if (statType == "Total"){

			$.getJSON("get_total",
			{
				column_name: measureType,
				activity_name: actType,
				athlete_id: 1,
				start_date: startDate,
        		end_date: today,
        		group_by: "day"
			},
				function(result)
				{
					drawGraph(result);
    			});
		}

		if (statType == "Average"){

			$.getJSON("get_average",
			{
				column_name: measureType,
				activity_name: actType,
				athlete_id: 1,
				start_date: startDate,
				end_date: today,
				group_by: "day"
			},
				function(result)
				{
					drawGraph(result);
				});
		}

		if (statType == "Maximum"){

		$.getJSON("get_maximum",
		{
			column_name: measureType,
			activity_name: actType,
			athlete_id: 1,
			start_date: startDate,
			end_date: today,
			group_by: "day"
		},
			function(result)
			{
				drawGraph(result);
			});
		}

		if (statType == "Minimum"){

		$.getJSON("get_minimum",
		{
			column_name: measureType,
			activity_name: actType,
			athlete_id: 1,
			start_date: startDate,
			end_date: today,
			group_by: "day"
		},
			function(result)
			{
				drawGraph(result);
			});
		}

	});//button click function

	//click the button to make a starting graph
	$("button").click();

});//document ready


//dateConversion function
//-----------------------
//takes the raw date given by new Date() and
//converts it into the format used by our database
// date - raw date to convert
// timeframe - "day","week","month","year"

function dateConversion(date,timeframe) {

    var result;

	//find the correct startDate based on selection
	if (timeframe == "day"){
		result = date.getFullYear() + "-" + (date.getMonth()+1) + "-" + date.getDate();
	}

	//TODO:fix this for when a week begins and ends in different months
	else if (timeframe == "week"){
		result = date.getFullYear() + "-" + (date.getMonth()+1) + "-" + (date.getDate()-date.getDay());
	}
	else if (timeframe == "month"){
		result = date.getFullYear() + "-" + (date.getMonth()+1) + "-1";
	}
	else if (timeframe == "year"){
		result = date.getFullYear() + "-1-1";
	}

	return result;
}


//drawGraph function
//------------------
//takes the raw "data" returned from the server to create a line graph
//	myData - the data sent back from the server after calling get_total, etc
//	it is in the format (value,year,month,day,...), this will need to be converted

function drawGraph(myData) {

	var strData = [];
	var splitStr = [];
	var myValues = [];
	var myDates = [];
	var year;
	var month;
	var day;

	//must convert data into a string format to manipulate it
	for (var i=0;i<myData.length;i++) {
		strData.push(String(myData[i]));
	}

	for (var i=0;i<strData.length;i++){

		splitStr = strData[i].split(",");

		for (var j=0;j<splitStr.length;j++){

			if (j%4 == 0) {
				myValues.push(parseInt(splitStr[j]));
			}

			else if (j%4 == 1){
				year = splitStr[j];
			}

			else if (j%4 == 2){
				month = splitStr[j]-1;
			}

			else if (j%4 == 3){
				day = splitStr[j];
				myDates.push(new Date(year,month,day));
			}//else
		}//for
	}//for

	//TODO: clean up hard-coded values in this function
	//TODO: adjust for any missed values along x-axis (day/month/year with no activities)

	var myChart = new Highcharts.Chart({
        chart: {
            renderTo: 'graphContainer',
            type: 'line'
        },
        title: {
            text: $("#select0").val()
        },
        xAxis: {
            categories: myDates
        },
        yAxis: {
            title: {
                text: $("#select2").val()
            }
        },
        series: [{
            name: 'Athlete Name',
            data: myValues
        }]
    });//draw graph function
}//drawgraph function

</script>

{% endblock script %}

{% block body %}

<div id="graphContainer" style="width:100%; height:400px;"></div>

<div id=search terms>
Activity:
<select size="1" id="select0">
	<option value ="Run" selected="selected">Run</option>
	<option value ="Walk">Walk</option>
	<option value ="Bike">Bike</option>
</select><br>
Display my:
<select size="1" id="select1">
	<option value ="Total" selected="selected">Total</option>
	<option value ="Average">Average</option>
	<option value ="Maximum">Maximum</option>
	<option value ="Minimum">Minimum</option>
</select>
<select size="1" id="select2">
	<option value ="distance" selected="selected">Distance</option>
	<option value ="duration">Duration</option>
	<option value ="max_speed">Top Speed</option>
</select>
 by
<select size="1" id="select3">
	<option value ="day">Day</option>
	<option value ="week" selected="selected">Week</option>
	<option value ="month">Month</option>
	<option value ="year">Year</option>
</select>
<button type="button" class="btn btn-primary" data-loading-text="Updating...">Update</button>
</div>

{% endblock body %}
